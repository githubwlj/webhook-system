{
  "permissions": {
    "allow": [
      "Bash(npm install:*)",
      "Bash(npm start)",
      "Bash(lsof:*)",
      "Bash(kill:*)",
      "Bash(PORT=6999 npm start)",
      "Bash(curl:*)",
      "Bash(chmod:*)",
      "Bash(./test_system.sh:*)",
      "Bash(node:*)",
      "Bash(pkill:*)",
      "Bash(./captcha_report.sh:*)",
      "Bash(./fix_report.sh)",
      "Bash(pm2 restart:*)",
      "Bash(pm2 list:*)",
      "Bash(pm2 stop:*)",
      "Bash(pm2 delete:*)",
      "Bash(pm2 start:*)",
      "Bash(pm2 logs:*)",
      "Bash(rm:*)",
      "Bash(# 3. 测试管理员令牌限制\necho \"\"👑 测试管理员令牌限制...\"\"\n\n# 尝试创建第一个管理员令牌\nADMIN_RESPONSE1=$(curl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"admin-token-1\"\",\"\"type\"\":\"\"admin\"\",\"\"description\"\":\"\"第一个管理员令牌\"\"}'')\n\nif echo \"\"$ADMIN_RESPONSE1\"\" | grep -q ''\"\"success\"\":true''; then\n    echo \"\"✅ 第一个管理员令牌创建成功\"\"\nelse\n    echo \"\"❌ 第一个管理员令牌创建失败: $ADMIN_RESPONSE1\"\"\nfi\n\n# 尝试创建第二个管理员令牌\nADMIN_RESPONSE2=$(curl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"admin-token-2\"\",\"\"type\"\":\"\"admin\"\",\"\"description\"\":\"\"第二个管理员令牌\"\"}'')\n\nif echo \"\"$ADMIN_RESPONSE2\"\" | grep -q \"\"只能存在一个管理员令牌\"\"; then\n    echo \"\"✅ 管理员令牌限制验证通过\"\"\nelse\n    echo \"\"❌ 管理员令牌限制验证失败: $ADMIN_RESPONSE2\"\"\nfi)",
      "Bash(# 检查令牌创建错误详情\ncurl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"admin-token-1\"\",\"\"type\"\":\"\"admin\"\",\"\"description\"\":\"\"测试管理员令牌\"\"}'' -w \"\"\\nHTTP Status: %{http_code}\\n\"\")",
      "Bash(echo)",
      "Bash(# 1. 创建管理员令牌\necho \"\"👑 创建管理员令牌...\"\"\nADMIN_TOKEN=$(curl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"Admin\"\",\"\"type\"\":\"\"admin\"\",\"\"description\"\":\"\"系统管理员令牌，拥有完全访问权限\"\"}'')\n\nif echo \"\"$ADMIN_TOKEN\"\" | grep -q ''\"\"success\"\":true''; then\n    echo \"\"✅ 管理员令牌创建成功\"\"\n    ADMIN_VALUE=$(echo \"\"$ADMIN_TOKEN\"\" | grep -o ''\"\"value\"\":\"\"[^\"\"]*\"\"'' | cut -d''\"\"'' -f4)\n    echo \"\"   令牌值: ${ADMIN_VALUE:0:20}...\"\"\nelse\n    echo \"\"❌ 管理员令牌创建失败: $ADMIN_TOKEN\"\"\nfi)",
      "Bash(# 2. UI访问令牌\necho \"\"🖥️ 创建UI访问令牌...\"\"\nUI_RESULT=$(curl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"UI-Access\"\",\"\"type\"\":\"\"ui_access\"\",\"\"description\"\":\"\"前端界面访问令牌，仅可访问监控页面\"\"}'')\n\nif echo \"\"$UI_RESULT\"\" | grep -q ''\"\"success\"\":true''; then\n    echo \"\"✅ UI访问令牌创建成功\"\"\nelse\n    echo \"\"❌ UI访问令牌创建失败: $UI_RESULT\"\"\nfi\n\n# 3. API访问令牌\necho \"\"🔌 创建API访问令牌...\"\"\nAPI_RESULT=$(curl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"API-Access\"\",\"\"type\"\":\"\"api_access\"\",\"\"description\"\":\"\"API接口访问令牌，可调用系统API\"\"}'')\n\nif echo \"\"$API_RESULT\"\" | grep -q ''\"\"success\"\":true''; then\n    echo \"\"✅ API访问令牌创建成功\"\"\nelse\n    echo \"\"❌ API访问令牌创建失败: $API_RESULT\"\"\nfi)",
      "Bash(# 4. Webhook密钥令牌\necho \"\"🔐 创建Webhook密钥令牌...\"\"\nWEBHOOK_RESULT=$(curl -s -X POST \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"name\"\":\"\"Webhook-Secret\"\",\"\"type\"\":\"\"webhook_secret\"\",\"\"description\"\":\"\"Webhook签名验证密钥\"\"}'')\n\nif echo \"\"$WEBHOOK_RESULT\"\" | grep -q ''\"\"success\"\":true''; then\n    echo \"\"✅ Webhook密钥令牌创建成功\"\"\nelse\n    echo \"\"❌ Webhook密钥令牌创建失败\"\"\nfi\n\necho \"\"\"\"\necho \"\"📋 查看当前令牌列表...\"\"\ncurl -s -X GET \"\"$BASE_URL/admin/tokens\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\" | python3 -m json.tool 2>/dev/null || echo \"\"令牌列表获取失败\"\")",
      "Bash(# 2. 创建测试webhook接收器并发送消息\necho \"\"2. 创建测试webhook接收器...\"\"\ncurl -s -X POST \"\"$BASE_URL/webhook/config/receiver\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\n        \"\"id\"\": \"\"test-logs\"\",\n        \"\"description\"\": \"\"测试日志接收器\"\"\n    }'' > /dev/null\n\necho \"\"✅ 测试webhook接收器已创建\"\"\n\n# 3. 发送多条测试消息\necho \"\"3. 发送应用活动消息...\"\"\ncurl -s -X POST \"\"$BASE_URL/webhook/receive/test-logs\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\n        \"\"event\"\": \"\"user_activity\"\",\n        \"\"message\"\": \"\"用户登录系统\"\",\n        \"\"user\"\": \"\"admin\"\",\n        \"\"ip\"\": \"\"127.0.0.1\"\",\n        \"\"timestamp\"\": \"\"''$(date -Iseconds)''\"\"\n    }'' > /dev/null\n\nsleep 1\n\necho \"\"4. 发送性能监控消息...\"\"\ncurl -s -X POST \"\"$BASE_URL/webhook/receive/test-logs\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\n        \"\"event\"\": \"\"performance_metrics\"\",\n        \"\"message\"\": \"\"系统性能报告\"\",\n        \"\"cpu_usage\"\": \"\"15%\"\",\n        \"\"memory_usage\"\": \"\"68%\"\",\n        \"\"active_connections\"\": 42,\n        \"\"timestamp\"\": \"\"''$(date -Iseconds)''\"\"\n    }'' > /dev/null)",
      "Bash(# 测试2: 使用指定接收器，带Bearer凭证\necho \"\"📡 测试2: 指定接收器，带Bearer凭证\"\"\necho \"\"地址: $BASE_URL/webhook/receive/test-logs\"\"\necho \"\"凭证: Bearer cf3346a1f6b872db50875869f859bf6f1b8ece3d3251f860482ac004ab2eb613\"\"\n\nRESPONSE2=$(curl -s -X POST \"\"$BASE_URL/webhook/receive/test-logs\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -H \"\"Authorization: Bearer cf3346a1f6b872db50875869f859bf6f1b8ece3d3251f860482ac004ab2eb613\"\" \\\n    -d ''{\n        \"\"type\"\": \"\"quota_exceed\"\",\n        \"\"title\"\": \"\"额度预警通知\"\",\n        \"\"content\"\": \"\"您的额度即将用尽，当前剩余额度为 {{value}}\"\",\n        \"\"values\"\": [\"\"$0.99\"\"],\n        \"\"timestamp\"\": 1739950503\n    }'')\n\nif echo \"\"$RESPONSE2\"\" | grep -q ''\"\"success\"\":true''; then\n    echo \"\"✅ 成功接收\"\"\nelse\n    echo \"\"❌ 接收失败\"\"\nfi\n\necho \"\"$RESPONSE2\"\" | head -1\necho \"\"\"\")",
      "Bash(# 测试3: 更多类型的通知测试\necho \"\"📡 测试3: 不同类型通知\"\"\n\n# 账单通知\necho \"\"💰 账单到期通知...\"\"\ncurl -s -X POST \"\"$BASE_URL/webhook\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\n        \"\"type\"\": \"\"bill_due\"\",\n        \"\"title\"\": \"\"账单到期提醒\"\",\n        \"\"content\"\": \"\"您的{{value}}账单将在{{value}}天后到期，金额为{{value}}\"\",\n        \"\"values\"\": [\"\"2025年1月\"\", \"\"7\"\", \"\"$129.99\"\"],\n        \"\"timestamp\"\": ''$(date +%s)''\n    }'' > /dev/null\n\n# 系统维护通知\necho \"\"🔧 系统维护通知...\"\"\ncurl -s -X POST \"\"$BASE_URL/webhook\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\n        \"\"type\"\": \"\"maintenance\"\",\n        \"\"title\"\": \"\"系统维护通知\"\",\n        \"\"content\"\": \"\"系统将于{{value}}进行维护，预计持续{{value}}小时\"\",\n        \"\"values\"\": [\"\"2025-01-15 02:00\"\", \"\"2\"\"],\n        \"\"timestamp\"\": ''$(date +%s)''\n    }'' > /dev/null\n\n# 安全警告\necho \"\"🚨 安全警告...\"\"\ncurl -s -X POST \"\"$BASE_URL/webhook\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\n        \"\"type\"\": \"\"security_alert\"\",\n        \"\"title\"\": \"\"安全警告\"\",\n        \"\"content\"\": \"\"检测到异常登录尝试，来源IP：{{value}}，尝试次数：{{value}}\"\",\n        \"\"values\"\": [\"\"192.168.1.100\"\", \"\"5\"\"],\n        \"\"timestamp\"\": ''$(date +%s)''\n    }'' > /dev/null\n\necho \"\"✅ 多种类型通知发送完成\"\"\necho \"\"\"\")",
      "Bash(# 验证webhook日志API\nBASE_URL=\"\"http://localhost:6997\"\"\n\n# 获取管理员令牌\nLOGIN_RESPONSE=$(curl -s -X POST \"\"$BASE_URL/admin/login\"\" \\\n    -H \"\"Content-Type: application/json\"\" \\\n    -d ''{\"\"username\"\":\"\"admin\"\",\"\"password\"\":\"\"admin123\"\",\"\"captcha\"\":\"\"12345\"\"}'')\nTOKEN=$(echo \"\"$LOGIN_RESPONSE\"\" | grep -o ''\"\"token\"\":\"\"[^\"\"]*\"\"'' | cut -d''\"\"'' -f4)\n\necho \"\"🔍 验证webhook日志API...\"\"\n\n# 调用webhook日志API\nLOGS_RESPONSE=$(curl -s -X GET \"\"$BASE_URL/webhook/logs?limit=5\"\" \\\n    -H \"\"Authorization: Bearer $TOKEN\"\")\n\necho \"\"📊 API返回数据预览:\"\"\necho \"\"$LOGS_RESPONSE\"\" | jq ''.logs | length'' 2>/dev/null || echo \"\"无法解析JSON\"\"\necho \"\"\"\"\n\nif echo \"\"$LOGS_RESPONSE\"\" | grep -q ''\"\"logs\"\"''; then\n    echo \"\"✅ Webhook日志API工作正常\"\"\n    \n    # 统计日志数量\n    LOG_COUNT=$(echo \"\"$LOGS_RESPONSE\"\" | grep -o ''{\"\"id\"\"'' | wc -l)\n    echo \"\"📈 返回的日志条数: $LOG_COUNT\"\"\n    \n    # 显示第一条日志的类型\n    FIRST_TYPE=$(echo \"\"$LOGS_RESPONSE\"\" | grep -o ''\"\"type\"\":\"\"[^\"\"]*\"\"'' | head -1 | cut -d''\"\"'' -f4)\n    echo \"\"🏷️ 最新日志类型: $FIRST_TYPE\"\"\nelse\n    echo \"\"❌ Webhook日志API返回异常\"\"\n    echo \"\"返回内容: $LOGS_RESPONSE\"\"\nfi)",
      "Bash(__NEW_LINE__ echo \"✅ 成功的配置方案：\")",
      "Bash(__NEW_LINE__ echo \"🔑 接口凭证配置：\")",
      "Bash(__NEW_LINE__ echo \"📋 在第三方系统中的配置示例：\")",
      "Bash(__NEW_LINE__ echo \"🎯 支持的通知类型：\")",
      "Bash(__NEW_LINE__ echo \"🔍 查看接收到的通知：\")",
      "Bash(fuser:*)",
      "Bash(PORT=6997 npm start)",
      "Bash(./test_enhanced_webhooks.sh:*)",
      "Bash(npm run restart:production:*)",
      "Bash(./restart-production.sh:*)",
      "Bash(find:*)",
      "Bash(docker exec:*)",
      "Bash(systemctl stop:*)",
      "Bash(systemctl:*)",
      "Bash(pm2 status:*)",
      "Bash(git init:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git remote add:*)",
      "Bash(git push:*)",
      "Bash(git remote set-url:*)",
      "Bash(npm restart)",
      "Bash(grep:*)",
      "Bash(sed:*)",
      "Bash(./status_report.sh)",
      "Bash(true)",
      "Bash(npm run:*)",
      "Bash(NODE_ENV=development npm run pm2:restart)",
      "Bash(nginx:*)",
      "Bash(/usr/local/openresty/bin/openresty:*)",
      "Bash(ls:*)",
      "Bash(openresty:*)",
      "Bash(cat:*)"
    ],
    "deny": []
  }
}